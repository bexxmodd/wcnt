name: New Release Issue

on:
  release:
    types: [published]

jobs:
  create_release_issue:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      issues: write

    steps:
      - name: 1. Checkout repository code
        uses: actions/checkout@v4

      - name: 2. Extract Assignee from Nested OWNERS File
        env:
          GH_TOKEN: ${{ github.token }}
          OWNERS_FILE: config/team.yaml
          RELEASE_VERSION: ${{ github.event.release.tag_name }}
          ISSUE_BODY: |
            A new version has been released and we need to publish the corresponding blog post.

            **Tag:** ${{ github.event.release.tag_name }}
            **Release Name:** ${{ github.event.release.name }}
            **Date Created:** ${{ github.event.release.created_at }}

            Please adhere to the k8s [blog post guidelines](https://kubernetes.io/docs/contribute/blog/article-submission/#route-1) when drafting the post.
            
            [View the full release notes here](${{ github.event.release.html_url }})

        run: |
          # Use yq to traverse the YAML structure and extract the first owner
          ASSIGNEE=$(yq '.team."blog-post-owners".members[0]' $OWNERS_FILE)
          
          echo "Extracted Assignee: $ASSIGNEE"
          
          # Use the pre-installed 'gh' CLI to create the issue.
          # The token is read automatically via the GITHUB_TOKEN environment variable.
          gh issue create \
            --title "Publish $RELEASE_VERSION release blog post!" \
            --body "$ISSUE_BODY" \
            --label "release-announcement" \
            --assignee "$ASSIGNEE"